{% extends "base.html" %}
{% block baseContents %}
{% load static %}

<style>
  .img-fluid{
    height: 100px;
  }
</style>

{% if user.is_authenticated %}
<div class="bg-light py-3">
  <div class="container">
    <div class="row">
      <div class="col-md-12 mb-0"><a href="{% url "home" %}">Home</a> <span class="mx-2 mb-0">/</span> <strong class="text-black">Cart</strong></div>
    </div>
  </div>
</div>
<div class="site-section">
  <div class="container">
    <div class="row mb-5">
      <form id="cart-form" class="col-md-12" method="post">
        <div class="site-blocks-table">
          <table class="table table-bordered">
            <thead>
              <tr>
                <th class="product-thumbnail">Image</th>
                <th class="product-name">Product</th>
                <th class="product-refreshrate">Refreshrate</th>
                <th class="product-size">Size</th>
                <th class="product-price">Price</th>
                <th class="product-quantity">Quantity</th>
                <th class="product-total">Total</th>
                <th class="product-remove">Remove</th>
              </tr>
            </thead>
            <tbody>
              {% for item in items %}
              <tr class="clickable-row" data-url="" style="cursor:pointer;" data-item-id="{{ item.id }}" data-stock="{{ item.varientId.stock }}">
                <td class="product-thumbnail">
                  <img src="{{ item.productId.image1.url }}" alt="Image" class="img-fluid">
                </td>
                <td class="product-name">
                  <h2 class="h5 text-black">{{ item.productId.name }}</h2>
                </td>
                <td class="product-refreshrate">{{ item.varientId.refreshRate.refreshRate }}Hz</td>
                <td class="product-size">{{ item.varientId.size.size }}Inch</td>
                <td class="product-price">₹{{ item.varientId.price }}</td>
                <td>
                  <div class="input-group mb-3" style="max-width: 120px;">
                    <div class="input-group-prepend">
                      <button class="btn btn-outline-primary js-btn-minus" data-action="decrease" data-item-id="{{ item.id }}" type="button">−</button>
                    </div>
                    <input type="text" class="form-control text-center quantity-input" value="{{ item.quantity }}" placeholder="" aria-label="Example text with button addon" data-item-id="{{ item.id }}" readonly>
                    <div class="input-group-append">
                      <button class="btn btn-outline-primary js-btn-plus" data-action="increase" data-item-id="{{ item.id }}" type="button">+</button>
                    </div>
                  </div>
                </td>
                <td class="product-total">₹{{ item.cartItemTotal }}</td>
                <td><button class="btn btn-primary btn-sm" onclick="confirmRemoveProduct('{% url "remove" item.id %}'); return false;">X</button></td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </form>
    </div>

    <div class="row">
      <div class="col-md-6">
        <div class="row mb-5">
          <div class="col-md-6">
            <a href="{% url 'shop' %}" class="btn btn-outline-primary btn-sm btn-block">Continue Shopping</a>
          </div>
        </div>
      </div>
      <div class="col-md-6 pl-5">
        <div class="row justify-content-end">
          <div class="col-md-7">
            <div class="row">
              <div class="col-md-12 text-right border-bottom mb-5">
                <h3 class="text-black h4 text-uppercase">Cart Totals</h3>
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-md-6">
                <span class="text-black">Subtotal</span>
              </div>
              <div class="col-md-6 text-right">
                <strong id="subtotal" class="text-black"></strong>
              </div>
            </div>
            <div class="row mb-5">
              <div class="col-md-6">
                <span class="text-black">Total</span>
              </div>
              <div class="col-md-6 text-right">
                <strong id="total" class="text-black"></strong>
              </div>
            </div>

            <div class="row">
              <div class="col-md-12">
                <a href="{% url 'checkOut' %}" class="btn btn-primary btn-lg py-3 btn-block">Proceed To Checkout</a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% else %}

<div class="container-fluid my-5">
  <div class="d-flex flex-column align-items-center justify-content-center">
    <h3 class="text-center">You are not authenticated</h3>
    <a href="{% url "signIn" %}" class="btn btn-primary mt-3">Sign In</a>
  </div>
</div>

{% endif %}

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>document.addEventListener('DOMContentLoaded', function() {
  const cartForm = document.getElementById('cart-form');

  function updateTotals() {
    let subtotal = 0;
    document.querySelectorAll('tbody tr').forEach(row => {
      const price = parseFloat(row.querySelector('.product-price').textContent.replace('₹', ''));
      const quantity = parseInt(row.querySelector('.quantity-input').value);
      const total = price * quantity;
      row.querySelector('.product-total').textContent = `₹${total.toFixed(2)}`;
      subtotal += total;
    });
    document.getElementById('subtotal').textContent = `₹${subtotal.toFixed(2)}`;
    document.getElementById('total').textContent = `₹${subtotal.toFixed(2)}`;
  }

  // Initial calculation of totals
  updateTotals();

  cartForm.addEventListener('click', function(event) {
    if (event.target.classList.contains('js-btn-plus') || event.target.classList.contains('js-btn-minus')) {
      const row = event.target.closest('tr');
      const quantityInput = row.querySelector('.quantity-input');
      const stock = parseInt(row.getAttribute('data-stock'));
      let quantity = parseInt(quantityInput.value);
      const itemId = event.target.getAttribute('data-item-id'); // Get item ID from the button

      // Check stock and limit quantity
      if (event.target.classList.contains('js-btn-plus')) {
        if (quantity < stock) {

        } else {
          Swal.fire({
            icon: 'error',
            title: 'Oops...',
            text: `Not enough stock available!`,
            timer: 2000,
            showConfirmButton: false
          });
          quantity = stock;
        }
      } else if (event.target.classList.contains('js-btn-minus')) {
        if (quantity > 1) {
          
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Oops...',
            text: 'Quantity cannot be less than 1!',
            timer: 2000,
            showConfirmButton: false
          });
          quantity = 1;
        }
      }

      // Update the quantity input field
      quantityInput.value = quantity;

      // Recalculate totals
      updateTotals();

      // Now trigger AJAX to update the quantity in the backend
      const action = event.target.classList.contains('js-btn-plus') ? 'increase' : 'decrease';
      updateQuantity(itemId, action);
    }
  });

  
  function updateQuantity(itemId, action) {
    fetch("{% url 'updateQuantity' %}", {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}',
      },
      body: JSON.stringify({
        'item_id': itemId,
        'action': action
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        console.log('Quantity updated successfully.');
      } else {
        console.error('Failed to update quantity:', data.error);
      }
    })
    .catch(error => console.error('Error:', error));
  }

  
  function showError() {
    Swal.fire({
      icon: 'error',
      title: 'Oops...',
      text: 'Please Add Items To the Cart',
      timer: 2000,
      timerProgressBar: true,
      didOpen: () => {
        Swal.showLoading();
      },
      willClose: () => {
        Swal.stopTimer();
      }
    });
  }

  
  function showSuccess() {
    Swal.fire({
      icon: 'success',
      title: 'Success!',
      text: 'Product Successfully Added',
      timer: 2000,
      timerProgressBar: true,
      didOpen: () => {
        Swal.showLoading();
      },
      willClose: () => {
        Swal.stopTimer();
      }
    });
  }

  // Check for messages or session flag for error/success handling
  document.addEventListener('DOMContentLoaded', (event) => {
    {% if messages %}
      {% for message in messages %}
        {% if message.tags == 'error' %}
          showError();
        {% elif message.tags == 'success' %}
          showSuccess();
        {% endif %}
      {% endfor %}
    {% endif %}
  });
});
function confirmRemoveProduct(url) {
  Swal.fire({
    title: 'Are you sure?',
    text: "You are about to Remove The Product!",
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#3085d6',
    cancelButtonColor: '#d33',
    confirmButtonText: 'Yes, Remove It!'
  }).then((result) => {
    if (result.isConfirmed) {
      window.location.href = url;
    }
  });
}
document.addEventListener('DOMContentLoaded', function() {
  var rows = document.querySelectorAll('.clickable-row');

  rows.forEach(function(row) {
    row.addEventListener('click', function(event) {
      if (event.target.tagName.toLowerCase() === 'button' ||
          event.target.tagName.toLowerCase() === 'a') {
        return;
      }
      window.location.href = this.dataset.url;
    });
  });
});  document.addEventListener('DOMContentLoaded', function() {
  var rows = document.querySelectorAll('.clickable-row');

  rows.forEach(function(row) {
    row.addEventListener('click', function(event) {
      if (event.target.tagName.toLowerCase() === 'button' ||
          event.target.tagName.toLowerCase() === 'a') {
        return;
      }
      window.location.href = this.dataset.url;
    });
  });
});
</script>

{% endblock %}
