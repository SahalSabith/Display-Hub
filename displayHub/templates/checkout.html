{% extends "base.html" %} {% block baseContents %} {% load static %}

<style>
  .remove-coupon-btn {
    background: none;
    border: none;
    font-size: 1.5rem;
    color: red;
    cursor: pointer;
  }

  .remove-coupon-btn:hover {
    color: darkred;
  }
  .available-coupons {
    max-height: 200px; /* Adjust height as needed */
    overflow-y: auto;
    border: 1px solid #dee2e6; /* Bootstrap's default border color */
    border-radius: 0.25rem; /* Rounded corners */
    background-color: #f8f9fa; /* Light background */
    padding: 15px;
    
    /* Hide scrollbar for webkit browsers */
    scrollbar-width: none; /* For Firefox */
}

/* Hide scrollbar for webkit browsers */
.available-coupons::-webkit-scrollbar {
    display: none; /* Safari and Chrome */
}

.coupon-list {
    display: flex;
    flex-direction: column;
}

.coupon-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
    border-bottom: 1px solid #dee2e6; /* Border between items */
}

.coupon-item:last-child {
    border-bottom: none; /* Remove bottom border for last item */
}

.coupon-item .apply-coupon {
    margin-left: 10px;
}
  
</style>

<div class="bg-light py-3">
  <div class="container">
    <div class="row">
      <div class="col-md-12 mb-0">
        <a href="{% url 'home' %}">Home</a>
        <span class="mx-2 mb-0">/</span>
        <a href="{% url 'cart' %}">Cart</a>
        <span class="mx-2 mb-0">/</span>
        <strong class="text-black">Checkout</strong>
      </div>
    </div>
  </div>
</div>

{% csrf_token %}
<div class="site-section">
  <div class="container">
    <h2 class="h3 mb-4 text-black">Check Out</h2>

    <div class="row">
      <!-- Product Table (now at the top) -->
      <div class="col-md-12 mb-4">
        <h3 class="h4 text-black mb-3">Your Products</h3>
        <div class="p-3 p-lg-5 border">
          <table class="table site-block-order-table mb-5">
            <thead>
              <tr>
                <th>Product</th>
                <th>Total</th>
              </tr>
            </thead>
            <tbody>
              {% for item in products %}
              <tr>
                <td>
                  {{ item.productId.name }} <strong class="mx-2">x</strong> {{item.quantity}}
                </td>
                <td>₹{{item.cartItemTotal}}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- Address Selection -->
      <div class="col-md-6 mb-4">
        <h3 class="h4 text-black mb-3">Shipping Address</h3>
        <div class="p-3 p-lg-5 border">
          <div class="form-group">
            <label for="select_address">Select Address</label>
            <select
              name="selectAddress"
              class="form-control"
              id="selectAddress"
            >
              {% for address in addresses %}
              <option value="{{ address.id }}">
                {{ address.name }}, {{ address.city }}
              </option>
              {% endfor %}
            </select>
          </div>
          <button
            type="button"
            class="btn btn-primary btn-lg py-3 btn-block"
            id="add_address_btn"
          >
            <a href="{% url 'addAddress' %}" class="text-white"
              >Add New Address</a
            >
          </button>
        </div>
      </div>

      <!-- Payment Options -->
      <div class="col-md-6 mb-4">
        <h3 class="h4 text-black mb-3">Payment Options</h3>
        <div class="p-3 p-lg-5 border">
          <label class="text-black">Choose a Payment Method:</label>
          <div class="form-group">
            <select
              name="paymentMethod"
              class="form-control"
              id="paymentMethod"
            >
              <option value="wallet">Wallet</option>
              <option value="cashOnDelivery">Cash on Delivery</option>
              <option value="internetBanking">Online Banking</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Coupon Section (now below the product table) -->
      <div class="col-md-12 mb-4">
        <div class="p-3 p-lg-5 border">
          <h3 class="h4 text-black mb-3">Apply Coupon</h3>
          <div class="input-group w-75 mb-3">
            <input
              name="couponCode"
              type="text"
              class="form-control"
              id="couponCode"
              placeholder="Enter Coupon Code"
              aria-label="Coupon Code"
              aria-describedby="button-addon2"
            />
            <div class="input-group-append">
              <button
                class="btn btn-primary btn-sm"
                type="button"
                id="applyCouponBtn"
              >
                Apply
              </button>
            </div>
          </div>

          <div class="available-coupons mb-3">
            <h4 class="h5 text-black mb-3">Available Coupons</h4>
            <div class="coupon-list">
              {% for coupon in coupons %}
                <div class="coupon-item">
                  <span>{{ coupon.couponCode }} - %{{ coupon.discountValue }}</span>
                  <button type="button" class="btn btn-sm btn-primary apply-coupon" data-code="{{ coupon.couponCode }}">
                    Apply
                  </button>
                </div>
              {% endfor %}
            </div>
          </div>          

          <ul class="list-group mb-4">
            <li
              class="list-group-item d-flex justify-content-between align-items-center"
            >
              Total Amount
              <span id="totalAmount">{{cart.cartTotal}}</span>
            </li>
            <li
              class="list-group-item d-flex justify-content-between align-items-center"
            >
              Delivery Charge
              <span class="text-success">Free Delivery</span>
            </li>
            <li
              class="list-group-item"
              id="couponDiv"
              style="display: none !important"
            >
              Coupon Discount
              <div class="d-flex flex-column align-items-end">
                <span id="coupontag" class="text-success"></span>
                <button
                  type="button"
                  id="removeCouponBtn"
                  class="remove-coupon-btn mt-2"
                  aria-label="Remove Coupon"
                >
                  &times;
                </button>
              </div>
            </li>
            <li
              class="list-group-item d-flex justify-content-between align-items-center"
            >
              Final Total
              <strong id="finalTotal">₹{{cart.cartTotal}}</strong>
            </li>
          </ul>

          <button
            id="checkOutBtn"
            type="button"
            class="btn btn-primary btn-lg py-3 btn-block"
          >
            Place Order
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
      function showError() {
          Swal.fire({
              icon: 'error',
              title: 'Oops...',
              text: 'You Should Choose one Payment Methode',
              timer: 2000,
              timerProgressBar: true,
              didOpen: () => {
                  Swal.showLoading();
              },
              willClose: () => {
                  Swal.stopTimer();
              }
          });
      }

      document.addEventListener('DOMContentLoaded', (event) => {
          {% if messages %}
              {% for message in messages %}
                  {% if message.tags == 'error' %}
                      showError();
                  {% endif %}
              {% endfor %}
          {% elif request.session.show_error %}
              showError();
              {% if request.session.show_error %}
                  {% with request.session.modified as modified %}
                  {% endwith %}
              {% endif %}
          {% endif %}
      })

      const couponBtn = document.getElementById('applyCouponBtn');
      couponBtn.addEventListener('click', () => {
      const couponCode = document.getElementById('couponCode').value.trim();
      const totalAmount = {{cart.cartTotal}}
      const finalTotalTag = document.getElementById('finalTotal')
      const coupontag = document.getElementById('coupontag')
      const couponDiv = document.getElementById('couponDiv')

          fetch("{% url 'applyCoupon' %}", {
              method: 'POST',
              body: JSON.stringify({ couponCode }),
              headers: {
                  'X-CSRFToken': '{{ csrf_token }}',
                  'Content-Type': 'application/json',
                  'Accept': 'application/json',
              },
          })
          .then(response => {
              if (!response.ok) {
                  return response.json().then(data => {
                      throw new Error(data.message || "Network response was not ok");
                  });
              }
              return response.json();
          })
          .then(data => {
              console.log("Response:", data);
              if(totalAmount<data.minPurchaseAmount){
                  return Swal.fire({
                  icon: 'error',
                  title: 'error!',
                  text: `You should Buy Minimum ${data.minPurchaseAmount} Of Products` ,
              });
              }
              if(totalAmount>data.maxPurchaseAmount){
                  return Swal.fire({
                  icon: 'error',
                  title: 'error!',
                  text: `Total amount exeeded ${data.maxPurchaseAmount}`,
              });
              }
              if (totalAmount >= data.minPurchaseAmount && totalAmount <= data.maxPurchaseAmount) {
                  discountAmount = totalAmount * data.discountValue / 100
                  finalTotal = totalAmount - discountAmount
                  finalTotalTag.textContent = '₹'+finalTotal

                  couponDiv.style.display = 'block'
                  coupontag.style.display = 'block'
                  coupontag.textContent = '-₹'+discountAmount
              Swal.fire({
                  icon: 'success',
                  title: 'Success!',
                  text: data.message,
              });
              }


          })
          .catch(error => {
              console.error("Error:", error);
              Swal.fire({
                  icon: 'error',
                  title: 'Oops...',
                  text: error.message || "Something went wrong!",
              });
          });
      });
      const checkOutBtn = document.getElementById('checkOutBtn');
checkOutBtn.addEventListener('click', () => {
    const selectedAddress = document.getElementById('selectAddress').value;
    const selectedPayment = document.getElementById('paymentMethod').value;
    const finalOrderPrice = Number(document.getElementById('finalTotal').textContent.replace('₹', ''));

    fetch("{% url 'checkOut' %}", {
        method: 'POST',
        body: JSON.stringify({ selectedAddress, selectedPayment, finalOrderPrice }),
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json',
            'Accept': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            if (selectedPayment === 'internetBanking') {
                // SweetAlert confirmation for internet banking
                Swal.fire({
                    title: 'Confirm Online Banking?',
                    text: "You will be redirected to the online banking page.",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, proceed!',
                    cancelButtonText: 'No, cancel!',
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Proceed with Razorpay payment
                        const options = {
                            key: data.razorpay_key,
                            amount: data.final_order_price * 100, // Amount in paise
                            currency: "INR",
                            name: data.order_name,
                            description: "Order Payment",
                            image: "https://example.com/logo", // Optional, your site logo
                            order_id: data.razorpay_order_id, // Razorpay order ID
                            callback_url: data.callback_url, // Your callback URL
                            prefill: {
                                name: "{{user.first_name}} {{ user.last_name }}",
                                email: "{{ user.email }}",
                                contact: data.selectedAddress  // Placeholder, update with user contact info
                            },
                            theme: {
                                color: "#3399cc"
                            }
                        };
                        const rzp = new Razorpay(options);
                        rzp.open();
                    }
                });
            } else if (selectedPayment === 'wallet') {
                // Redirect to the order confirmation page for wallet and cash on delivery payments
                Swal.fire({
                  title: 'Confirm Wallet Payment?',
                  text: "You will Place The Order.",
                  icon: 'warning',
                  showCancelButton: true,
                  confirmButtonText: 'Yes, proceed!',
                  cancelButtonText: 'No, cancel!',
              }).then((result) => {
                if (result.isConfirmed) {
                  window.location.href = "{% url 'order' %}";
                }
              })
            } else if (selectedPayment === 'cashOnDelivery'){
              Swal.fire({
                title: 'Confirm Wallet Payment?',
                text: "You will Place The Order by Cash On Delivery.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes, proceed!',
                cancelButtonText: 'No, cancel!',
            }).then((result) => {
              if (result.isConfirmed) {
                window.location.href = "{% url 'order' %}";
              }
            })
            }
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Oops...',
                text: data.message,
            });
        }
    })
    .catch(error => {
        console.error("Error:", error);
        Swal.fire({
            icon: 'error',
            title: 'Oops...',
            text: error.message || "Something went wrong!",
        });
    });
});
  const removeCouponBtn = document.getElementById('removeCouponBtn')
  removeCouponBtn.addEventListener('click', () => {
    const totalAmount = {{cart.cartTotal}}
    const finalTotalTag = document.getElementById('finalTotal')
    const coupontag = document.getElementById('coupontag')
    const couponDiv = document.getElementById('couponDiv')
    finalTotalTag.textContent = '₹'+totalAmount
    couponDiv.style.display = 'none'
    coupontag.style.display = 'none'
  })
const applyCouponButtons = document.querySelectorAll('.apply-coupon');

applyCouponButtons.forEach(button => {
  button.addEventListener('click', function() {
    const couponCode = this.getAttribute('data-code');
    console.log(couponCode);
    const couponCodeInput = document.getElementById('couponCode')
    couponCodeInput.value = couponCode
  });
});
</script>
{% endblock %}
