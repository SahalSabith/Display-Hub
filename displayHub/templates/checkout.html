{% extends "base.html" %}
{% block baseContents %}
{% load static %}

<div class="bg-light py-3">
  <div class="container">
      <div class="row">
          <div class="col-md-12 mb-0">
              <a href="{% url 'home' %}">Home</a> 
              <span class="mx-2 mb-0">/</span> 
              <a href="{% url 'cart' %}">Cart</a> 
              <span class="mx-2 mb-0">/</span> 
              <strong class="text-black">Checkout</strong>
          </div>
      </div>
  </div>
</div>

<form>
  {% csrf_token %}
  <div class="site-section">
      <div class="container">
          <h2 class="h3 mb-4 text-black">Check Out</h2>

          <div class="row">
              <!-- Product Table (now at the top) -->
              <div class="col-md-12 mb-4">
                  <h3 class="h4 text-black mb-3">Your Products</h3>
                  <div class="p-3 p-lg-5 border">
                      <table class="table site-block-order-table mb-5">
                          <thead>
                              <tr>
                                  <th>Product</th>
                                  <th>Total</th>
                              </tr>
                          </thead>
                          <tbody>
                              {% for item in products %}
                              <tr>
                                  <td>{{ item.productId.name }} <strong class="mx-2">x</strong> {{ item.quantity }}</td>
                                  <td>₹{{item.cartItemTotal}}</td>
                              </tr>
                              {% endfor %}
                            </tbody>
                      </table>
                  </div>
              </div>

              <!-- Address Selection -->
              <div class="col-md-6 mb-4">
                <h3 class="h4 text-black mb-3">Shipping Address</h3>
                <div class="p-3 p-lg-5 border">
                    <div class="form-group">
                        <label for="select_address">Select Address</label>
                        <select name="address" class="form-control" id="select_address">
                            {% for address in addresses %}
                            <option value="{{ address.id }}">{{ address.name }}, {{ address.city }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <button type="button" class="btn btn-primary btn-lg py-3 btn-block" id="add_address_btn">
                        <a href="{% url 'addAddress' %}" class="text-white">Add New Address</a>
                    </button>
                </div>
            </div>

            <!-- Payment Options -->
            <div class="col-md-6 mb-4">
                <h3 class="h4 text-black mb-3">Payment Options</h3>
                <div class="p-3 p-lg-5 border">
                    <label class="text-black">Choose a Payment Method:</label>
                    <div class="form-group">
                        <label class="radio-inline mr-3">
                            <input class="paymentMethod" type="radio" name="paymentMethod" value="wallet"> Wallet
                        </label>
                        <label class="radio-inline mr-3">
                            <input class="paymentMethod" type="radio" name="paymentMethod" value="cashOnDelivery"> Cash on Delivery
                        </label>
                        <label class="radio-inline">
                            <input class="paymentMethod" type="radio" name="paymentMethod" value="internetBanking"> Online Banking
                        </label>
                    </div>
                </div>
            </div>

              <!-- Coupon Section (now below the product table) -->
              <div class="col-md-12 mb-4">
                  <div class="p-3 p-lg-5 border">
                      <h3 class="h4 text-black mb-3">Apply Coupon</h3>
                      <div class="input-group w-75 mb-3">
                          <input name="couponCode" type="text" class="form-control" id="couponCode" placeholder="Enter Coupon Code" aria-label="Coupon Code" aria-describedby="button-addon2">
                          <div class="input-group-append">
                              <button class="btn btn-primary btn-sm" type="button" id="applyCouponBtn">Apply</button>
                          </div>
                      </div>
                      <ul class="list-group mb-4">
                          <li class="list-group-item d-flex justify-content-between align-items-center">
                              Total Amount
                              <span id="totalAmount">{{cart.cartTotal}}</span>
                          </li>
                          <li class="list-group-item d-flex justify-content-between align-items-center">
                              Delivery Charge
                              <span class="text-success">Free Delivery</span>
                          </li>
                          <li class="list-group-item d-flex justify-content-between align-items-center" style="display: none !important;" id="couponDiv">
                              Coupon Discount
                              <span id="coupontag" class="text-succes"></span>
                          </li>
                          <li class="list-group-item d-flex justify-content-between align-items-center">
                              Final Total
                              <strong id="finalTotal">₹{{cart.cartTotal}}</strong>
                          </li>
                      </ul>

                      <button id="checkOutBtn" type="button" class="btn btn-primary btn-lg py-3 btn-block">Place Order</button>
                  </div>
              </div>
          </div>

      </div>
  </div>
</form>


<script>
    function showError() {
        Swal.fire({
            icon: 'error',
            title: 'Oops...',
            text: 'You Should Choose one Payment Methode',
            timer: 2000,
            timerProgressBar: true,
            didOpen: () => {
                Swal.showLoading();
            },
            willClose: () => {
                Swal.stopTimer();
            }
        });
    }

    document.addEventListener('DOMContentLoaded', (event) => {
        {% if messages %}
            {% for message in messages %}
                {% if message.tags == 'error' %}
                    showError();
                {% endif %}
            {% endfor %}
        {% elif request.session.show_error %}
            showError();
            {% if request.session.show_error %}
                {% with request.session.modified as modified %}
                {% endwith %}
            {% endif %}
        {% endif %}
    })

    const couponBtn = document.getElementById('applyCouponBtn');
    couponBtn.addEventListener('click', () => {
    const couponCode = document.getElementById('couponCode').value.trim();
    const stringTotal = document.getElementById('totalAmount').textContent
    const totalAmount = Number(stringTotal)
    const finalTotalTag = document.getElementById('finalTotal')
    const coupontag = document.getElementById('coupontag')
    const couponDiv = document.getElementById('couponDiv')
        
        fetch("{% url 'applyCoupon' %}", {
            method: 'POST',
            body: JSON.stringify({ couponCode }),
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
                'Accept': 'application/json',
            },
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(data.message || "Network response was not ok");
                });
            }
            return response.json();
        })
        .then(data => {
            console.log("Response:", totalAmount);

            discountAmount = totalAmount * data.discountValue / 100
            finalTotal = totalAmount - discountAmount
            finalTotalTag.textContent = '₹'+finalTotal

            couponDiv.style.display = 'block'
            coupontag.style.display = 'block'
            coupontag.textContent = '-₹'+discountAmount

            Swal.fire({
                icon: 'success',
                title: 'Success!',
                text: data.message,
            });
        })
        .catch(error => {
            console.error("Error:", error);
            Swal.fire({
                icon: 'error',
                title: 'Oops...',
                text: error.message || "Something went wrong!", // Corrected to display error.message
            });
        });
    });
    const checkOutBtn = document.getElementById('checkOutBtn');
    checkOutBtn.addEventListener('click', () => {
        const finalTotalTag = document.getElementById('finalTotal').textContent;
        const paymentMethods = document.getElementsByClassName('paymentMethod');

        let selectedPaymentMethod;
        for (let method of paymentMethods) {
            if (method.checked) {
                selectedPaymentMethod = method.value;
                break;
            }
        }

        const selectAddress = document.getElementById('select_address');
        const selectedValue = selectAddress.value;

        const checkOutData = {
            finalTotal: finalTotalTag,
            paymentMethod: selectedPaymentMethod,
            address: selectedValue
        };

        fetch("{% url 'checkOut' %}", {
            method: 'POST',
            body: JSON.stringify(checkOutData),
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
                'Accept': 'application/json',
            },
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(data.message || "Network response was not ok");
                });
            }
            return response.json();
        })
        .then(data => {
            console.log("Response:", totalAmount);
            Swal.fire({
                icon: 'success',
                title: 'Success!',
                text: data.message,
            });
        })
        .catch(error => {
            console.error("Error:", error);
            Swal.fire({
                icon: 'error',
                title: 'Oops...',
                text: error.message || "Something went wrong!",
            });
        });
    });
</script>



{% endblock %}
