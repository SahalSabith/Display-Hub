{% extends "base.html" %}
{% block baseContents %}
{% load static %}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">\
<style>
  .checkout-container {
    max-width: 1000px;
    margin: 0 auto;
    padding: 15px;
    font-family: 'Roboto', sans-serif;
    background-color: #f7f9fc;
}

.checkout-header {
    background-color: #9A94EF;
    padding: 10px;
    margin-bottom: 20px;
    color: #fff;
    text-align: center;
    border-radius: 6px;
}

.checkout-header h2 {
    font-size: 1.6em;
}

.checkout-step {
    background-color: #fff;
    border: 1px solid #e3e6f0;
    border-radius: 6px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
}

.checkout-step h3 {
    padding-bottom: 10px;
    font-size: 1.3em;
}

.product-summary, .order-summary {
    background-color: #f1f4f8;
    padding: 15px;
    border-radius: 6px;
    border: 1px solid #dce1e8;
}

.product-item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
    font-size: 1em;
}

.coupon-section {
    display: flex;
    align-items: center;
    margin-bottom: 15px;
}

.coupon-input {
    flex-grow: 1;
    margin-right: 10px;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 6px;
}

.apply-coupon {
    padding: 5px 10px;
    background-color: #9A94EF;
    color: #fff;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9em;
}

.apply-coupon:hover {
    background-color: #847ee0;
}

.order-total {
    font-size: 1.2em;
    font-weight: bold;
}

.place-order-btn {
    width: 100%;
    padding: 15px;
    background-color: #28a745;
    color: #fff;
    border: none;
    border-radius: 6px;
    font-size: 1.1em;
}

.place-order-btn:hover {
    background-color: #218838;
}

#couponDiv {
    display: none;
}

#coupontag {
    color: #28a745;
    font-weight: bold;
}

.final-total {
    font-size: 1.3em;
    color: #9A94EF;
}
</style>

<div class="checkout-container">
  <div class="checkout-header">
    <h2>Checkout</h2>
  </div>

  <div id="accordion">
    <div class="card">
      <div class="card-header" id="headingOne">
        <h5 class="mb-0">
          <button class="btn btn-link" data-toggle="collapse" data-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
            1. Shipping Address
          </button>
        </h5>
      </div>
  
      <div id="collapseOne" class="collapse show" aria-labelledby="headingOne" data-parent="#accordion">
        <div class="card-body">
          <select name="selectAddress" class="form-control" id="selectAddress">
            {% for address in addresses %}
              <option value="{{ address.id }}">{{ address.name }}, {{ address.city }}</option>
            {% endfor %}
          </select>
          <a href="{% url 'addAddress' %}" class="btn mt-3 text-white" style="background:#9A94EF;">Add New Address</a>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-header" id="headingTwo">
        <h5 class="mb-0">
          <button class="btn btn-link collapsed" data-toggle="collapse" data-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
            2. Payment Method
          </button>
        </h5>
      </div>
      <div id="collapseTwo" class="collapse" aria-labelledby="headingTwo" data-parent="#accordion">
        <div class="card-body">
          <select name="paymentMethod" class="form-control" id="paymentMethod">
            <option value="wallet">Wallet</option>
            <option value="cashOnDelivery">Cash on Delivery</option>
            <option value="internetBanking">Online Banking</option>
          </select>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-header" id="headingFour">
        <h5 class="mb-0">
          <button class="btn btn-link collapsed" data-toggle="collapse" data-target="#collapseFour" aria-expanded="false" aria-controls="collapseFour">
            4. Coupons
          </button>
        </h5>
      </div>
      <div id="collapseFour" class="collapse" aria-labelledby="headingFour" data-parent="#accordion">
        <div class="card-body">
          <div class="coupon-section">
            <input type="text" id="couponCode" class="form-control coupon-input" placeholder="Enter coupon code">
            <button id="applyCouponBtn" class="btn btn-primary">Apply</button>
          </div>
          <div class="available-coupons">
            <h4>Available Coupons</h4>
            {% for coupon in coupons %}
              <div class="coupon-item">
                <span>{{ coupon.couponCode }} - {{ coupon.discountValue }}% off</span>
                <button class="btn btn-sm btn-outline-primary apply-coupon" data-code="{{ coupon.couponCode }}">Apply</button>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>

<div class="checkout-step">
  <h3>3. Review Items and Shipping</h3>
  <div class="product-summary">
    {% for item in products %}
      <div class="product-item">
        <span>{{ item.productId.name }} x {{item.quantity}}</span>
        <span>₹{{item.cartItemTotal}}</span>
      </div>
    {% endfor %}
  </div>
</div>

  <div class="checkout-step">
    <h3>5. Order Summary</h3>
    <div class="order-summary">
      <div class="product-item">
        <span>Items:</span>
        <span id="totalAmount">₹{{cart.cartTotal}}</span>
      </div>
      <div class="product-item">
        <span>Delivery:</span>
        <span class="text-success">Free</span>
      </div>
      <div class="product-item" id="couponDiv" style="display: none;">
        <span>Coupon Discount:</span>
        <span id="coupontag" class="text-success"></span>
        <i class="fas fa-times remove-coupon" id="removeCouponBtn" style="cursor: pointer; margin-left: 5px;"></i>
      </div>
      <div class="product-item order-total">
        <span>Order Total:</span>
        <strong id="finalTotal">₹{{cart.cartTotal}}</strong>
      </div>
    </div>
  </div>

  <button id="checkOutBtn" class="place-order-btn">Place Your Order</button>
</div>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
  function requestNotificationPermission() {
    if ('Notification' in window) {
        Notification.requestPermission().then(function(result) {
            console.log('Notification permission:', result);
        });
    }
}
  document.addEventListener('DOMContentLoaded', function() {
    {% if messages %}
        {% for message in messages %}
            Swal.fire({
                icon: 'warning',
                title: 'Warning',
                text: "{{ message }}",
                showConfirmButton: false,
                timer: 2000
            });
            setTimeout(function() {
              window.location.reload()
            }, 2000);  
        {% endfor %}
    {% endif %}
});
      function showError() {
          Swal.fire({
              icon: 'error',
              title: 'Oops...',
              text: 'You Should Choose one Payment Methode',
              timer: 2000,
              timerProgressBar: true,
              didOpen: () => {
                  Swal.showLoading();
              },
              willClose: () => {
                  Swal.stopTimer();
              }
          });
      }

      document.addEventListener('DOMContentLoaded', (event) => {
          {% if messages %}
              {% for message in messages %}
                  {% if message.tags == 'error' %}
                      showError();
                  {% endif %}
              {% endfor %}
          {% elif request.session.show_error %}
              showError();
              {% if request.session.show_error %}
                  {% with request.session.modified as modified %}
                  {% endwith %}
              {% endif %}
          {% endif %}
      })

      document.addEventListener('DOMContentLoaded', () => {
        // Handle manual coupon code input
        const couponBtn = document.getElementById('applyCouponBtn');
        couponBtn.addEventListener('click', applyCoupon);
    
        // Handle "Apply" button click from available coupons
        const applyCouponButtons = document.querySelectorAll('.apply-coupon');
        applyCouponButtons.forEach(button => {
            button.addEventListener('click', function() {
                const couponCode = this.getAttribute('data-code');
                const couponCodeInput = document.getElementById('couponCode');
                couponCodeInput.value = couponCode;
                applyCoupon();
            });
        });
    });
    
    function applyCoupon() {
      const couponCode = document.getElementById('couponCode').value.trim();
      const totalAmount = parseFloat(document.getElementById('totalAmount').textContent.replace('₹', ''));
      const finalTotalTag = document.getElementById('finalTotal');
      const couponTag = document.getElementById('coupontag');
      const couponDiv = document.getElementById('couponDiv');
  
      if (!couponCode) {
          Swal.fire({
              icon: 'error',
              title: 'No Coupon Code',
              text: 'Please enter or select a coupon code.',
          });
          return;
      }
  
      fetch("{% url 'applyCoupon' %}", {
          method: 'POST',
          body: JSON.stringify({ couponCode, totalAmount }),
          headers: {
              'X-CSRFToken': '{{ csrf_token }}',
              'Content-Type': 'application/json',
          },
      })
      .then(response => response.json())
      .then(data => {
          if (data.status === 'success') {
              finalTotalTag.textContent = '₹' + data.finalTotal.toFixed(2);
              couponDiv.style.display = 'block';
              couponTag.textContent = '-₹' + data.discountAmount.toFixed(2);
  
              Swal.fire({
                  icon: 'success',
                  title: 'Coupon Applied',
                  text: data.message,
              });
  
              // Store applied coupon in localStorage
              localStorage.setItem('appliedCoupon', JSON.stringify({
                  code: couponCode,
                  discountAmount: data.discountAmount,
                  finalTotal: data.finalTotal
              }));
          } else {
              Swal.fire({
                  icon: 'error',
                  title: 'Error',
                  text: data.message,
              });
          }
      })
      .catch(error => {
          console.error('Error:', error);
          Swal.fire({
              icon: 'error',
              title: 'Error',
              text: 'Failed to apply the coupon. Please try again.',
          });
      });
  }
  
  function checkStoredCoupon() {
      const storedCoupon = localStorage.getItem('appliedCoupon');
      if (storedCoupon) {
          const couponData = JSON.parse(storedCoupon);
          const couponCodeInput = document.getElementById('couponCode');
          const finalTotalTag = document.getElementById('finalTotal');
          const couponTag = document.getElementById('coupontag');
          const couponDiv = document.getElementById('couponDiv');
  
          if (couponCodeInput) couponCodeInput.value = couponData.code;
          if (finalTotalTag) finalTotalTag.textContent = '₹' + couponData.finalTotal.toFixed(2);
          if (couponTag) couponTag.textContent = '-₹' + couponData.discountAmount.toFixed(2);
          if (couponDiv) couponDiv.style.display = 'block';
      }
  }
  
  function removeCoupon() {
      localStorage.removeItem('appliedCoupon');
      document.getElementById('couponCode').value = '';
      document.getElementById('finalTotal').textContent = document.getElementById('totalAmount').textContent;
      document.getElementById('coupontag').textContent = '';
      document.getElementById('couponDiv').style.display = 'none';
  
      // You may want to add an API call here to remove the coupon on the server-side as well
  }
  
  // Call this function when the page loads
  document.addEventListener('DOMContentLoaded', function() {
      checkStoredCoupon();
      
      // Add event listener for remove coupon button
      const removeCouponBtn = document.getElementById('removeCouponBtn');
      if (removeCouponBtn) {
          removeCouponBtn.addEventListener('click', removeCoupon);
      }
  }); 
    const checkOutBtn = document.getElementById('checkOutBtn');
    checkOutBtn.addEventListener('click', () => {
      const selectedAddress = document.getElementById('selectAddress').value;
      const selectedPayment = document.getElementById('paymentMethod').value;
      const finalOrderPrice = Number(document.getElementById('finalTotal').textContent.replace('₹', ''));
  
      // Function to fetch wallet balance
      function fetchWalletBalance() {
        return fetch("{% url 'get_wallet_balance' %}")
          .then(response => response.json())
          .then(data => data.balance);
      }
  
      // Function to show wallet modal
      function showWalletModal(balance, finalOrderPrice) {
        return new Promise((resolve, reject) => {
          Swal.fire({
            title: 'Wallet Payment',
            html: `
              <p>Available Balance: ₹${balance.toFixed(2)}</p>
              <p>Order Total: ₹${finalOrderPrice.toFixed(2)}</p>
              ${balance < finalOrderPrice ? '<p class="text-danger">Insufficient balance!</p>' : ''}
            `,
            icon: balance < finalOrderPrice ? 'error' : 'info',
            showCancelButton: true,
            confirmButtonText: 'Approve Payment',
            cancelButtonText: 'Reject',
            allowOutsideClick: false,
          }).then((result) => {
            if (result.isConfirmed && balance >= finalOrderPrice) {
              resolve(true);
            } else {
              reject('Payment cancelled or insufficient balance');
            }
          });
        });
      }
  
      document.getElementById('placeOrder').addEventListener('click', function(event) {
        event.preventDefault();  // Prevent immediate form submission
        requestNotificationPermission();
        // Wait a bit to allow the permission request to complete
        setTimeout(function() {
            // Main checkout process
      fetch("{% url 'checkOut' %}", {
        method: 'POST',
        body: JSON.stringify({ selectedAddress, selectedPayment, finalOrderPrice }),
        headers: {
          'X-CSRFToken': '{{ csrf_token }}',
          'Content-Type': 'application/json',
          'Accept': 'application/json',
        },
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          if (selectedPayment === 'internetBanking') {
            // SweetAlert confirmation for internet banking
            Swal.fire({
                title: 'Confirm Online Banking?',
                text: "You will be redirected to the online banking page.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes, proceed!',
                cancelButtonText: 'No, cancel!',
            }).then((result) => {
                if (result.isConfirmed) {
                    // Proceed with Razorpay payment
                    const options = {
                        key: data.razorpay_key,
                        amount: data.final_order_price * 100, // Amount in paise
                        currency: "INR",
                        name: data.order_name,
                        description: "Order Payment",
                        image: "https://example.com/logo", // Optional, your site logo
                        order_id: data.razorpay_order_id, // Razorpay order ID
                        callback_url: data.callback_url, // Your callback URL
                        prefill: {
                            name: "{{user.first_name}} {{ user.last_name }}",
                            email: "{{ user.email }}",
                            contact: data.selectedAddress  // Placeholder, update with user contact info
                        },
                        theme: {
                            color: "#3399cc"
                        },
                        modal: {
                            ondismiss: function() {
                                // Show SweetAlert when payment modal is closed
                                Swal.fire({
                                    title: 'Payment Failed',
                                    text: 'The payment process was interrupted. Please try again.',
                                    icon: 'error',
                                    confirmButtonText: 'OK'
                                }).then((result) => {
                                    // Redirect to the orders page after the SweetAlert is closed
                                    window.location.href = "{% url 'order' %}";
                                });
                            }
                        }
                    };
                    const rzp = new Razorpay(options);
                    rzp.open();
                }
            });
        } else if (selectedPayment === 'wallet') {
              fetchWalletBalance()
                .then(balance => showWalletModal(balance, finalOrderPrice))
                .then(() => {
                  // Wallet payment approved
                  return fetch("{% url 'process_wallet_payment' %}", {
                    method: 'POST',
                    body: JSON.stringify({ finalOrderPrice }),
                    headers: {
                      'X-CSRFToken': '{{ csrf_token }}',
                      'Content-Type': 'application/json',
                      'Accept': 'application/json',
                    },
                  });
                })
                .then(response => response.json())
                .then(data => {
                  if (data.status === 'success') {
                    Swal.fire({
                      icon: 'success',
                      title: 'Payment Successful',
                      text: 'Your order has been placed successfully!',
                    }).then(() => {
                      window.location.href = "{% url 'successPage' %}";
                    });
                  } else {
                    throw new Error(data.message);
                  }
                })
                .catch(error => {
                  Swal.fire({
                    icon: 'error',
                    title: 'Oops...',
                    text: error.message || "Something went wrong with the wallet payment!",
                  });
                });
            } else if (selectedPayment === 'cashOnDelivery') {
              Swal.fire({
                title: 'Confirm Cash on Delivery?',
                text: "You will place the order for Cash on Delivery.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes, proceed!',
                cancelButtonText: 'No, cancel!',
              }).then((result) => {
                if (result.isConfirmed) {
                  window.location.href = "{% url 'successPage' %}";
                }
              });
            }
          } else {
            Swal.fire({
              icon: 'error',
              title: 'Oops...',
              text: data.message,
            });
          }
        })
        .catch(error => {
          console.error("Error:", error);
          Swal.fire({
            icon: 'error',
            title: 'Oops...',
            text: error.message || "Something went wrong!",
          });
        });
      });
        }, 1000);
    });
  const removeCouponBtn = document.getElementById('removeCouponBtn')
  removeCouponBtn.addEventListener('click', () => {
    const totalAmount = {{cart.cartTotal}}
    const finalTotalTag = document.getElementById('finalTotal')
    const coupontag = document.getElementById('coupontag')
    const couponDiv = document.getElementById('couponDiv')
    finalTotalTag.textContent = '₹'+totalAmount
    couponDiv.style.display = 'none'
    coupontag.style.display = 'none'
  })
</script>
{% endblock %}
