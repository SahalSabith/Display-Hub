{% extends "base.html" %}
{% block baseContents %}
{% load static %}
<link rel="stylesheet" href="{% static "css/productInfo.css" %}">
<style>
    .wishlist-btn {
        background-color: transparent;
        border: none;
        cursor: pointer;
        padding: 0;
        transition: all 0.3s ease;
        outline: none; /* Remove default outline */
    }
    .wishlist-btn:focus {
        outline: none; /* Remove outline on focus */
    }
    .wishlist-btn:focus-visible {
        /* Optional: Add a custom focus style for keyboard navigation */
        box-shadow: 0 0 0 2px rgba(255,0,0,0.5);
    }
    .heart-icon {
        fill: transparent;
        stroke: red;
        stroke-width: 2;
        transition: all 0.3s ease;
    }
    .wishlist-btn.active .heart-icon {
        fill: red;
    }
</style>
<div class="site-section">
    <div class="container">
        <div class="row">
            <!-- Thumbnails and Main Image -->
            <div class="col-md-6 d-flex">
                <div class="thumbnails col-3 d-flex flex-column">
                    {% if product.image1 %}
                        <img src="{{ product.image1.url }}" class="thumbnail-img mb-2" onclick="updateMainImage('{{ product.image1.url }}')">
                    {% endif %}
                    {% if product.image2 %}
                        <img src="{{ product.image2.url }}" class="thumbnail-img mb-2" onclick="updateMainImage('{{ product.image2.url }}')">
                    {% endif %}
                    {% if product.image3 %}
                        <img src="{{ product.image3.url }}" class="thumbnail-img mb-2" onclick="updateMainImage('{{ product.image3.url }}')">
                    {% endif %}
                    {% if product.image4 %}
                        <img src="{{ product.image4.url }}" class="thumbnail-img mb-2" onclick="updateMainImage('{{ product.image4.url }}')">
                    {% endif %}
                </div>
                <div class="main-image col-9">
                    <img id="mainImage" src="{{ product.image1.url }}" alt="Product Image" class="img-fluid zoomable" onmousemove="zoomImage(event)" onmouseleave="resetZoom()">
                </div>
            </div>

            <!-- Product Information Section -->
            <div class="col-md-6 product-info-section">
                <h2 class="productName">{{ product.name }}</h2>
                <h6><strong id="price" class="text-primary h4">₹ {{ product.varient.first.price }}</strong></p>
                <h6 id="size">Size: {{ product.varient.first.size.size }} inch</h6>
                <h6>Resolution: {{ product.resolution }}p</h6>
                <h6 id="refreshRate">Refresh Rate: {{ product.varient.first.refreshRate.refreshRate }}Hz</h6>
                    <h6 id="stock">Only {{ product.varient.first.stock }} Left</h6>

                <!-- Variant Selection -->
                <div class="filter-options horizontal-options">
                    <legend>Monitor Size</legend>
                    <div id="sizeOptions" class="option-item">
                        {% for size in varientSize %}
                        <div class="option-item">
                            <input type="radio" id="size-{{ size.size_id }}" name="monitorSize" value="{{size.size_id}}" />
                            <label for="size-{{ size.size_id }}">{{size.size__size}} inches</label>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <div class="filter-options horizontal-options">
                    <legend>Refresh Rate</legend>
                    <div id="refreshRateOptions" class="option-item">
                        {% for refreshrate in varientRefreshRates %}
                        <div class="option-item">
                            <input type="radio" id="refresh-{{ refreshrate.refreshRate_id }}" name="refreshRate" value="{{ refreshrate.refreshRate_id }}" />
                            <label for="refresh-{{ refreshrate.refreshRate_id }}">{{ refreshrate.refreshRate__refreshRate }} Hz</label>
                        </div>
                        {% endfor %}
                    </div>
                </div>                          
              
                <!-- Customer Reviews -->
                <div class="star-rating d-flex">
                    <i class="bi bi-star" data-value="1"></i>
                    <i class="bi bi-star" data-value="2"></i>
                    <i class="bi bi-star" data-value="3"></i>
                    <i class="bi bi-star" data-value="4"></i>
                    <i class="bi bi-star" data-value="5"></i>
                </div>

                <button class="wishlist-btn" id="wishlistBtn" aria-label="Add to Wishlist">
                    <svg class="heart-icon" viewBox="0 0 24 24" width="24" height="24">
                        <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                    </svg>
                </button>
              
                <!-- Buttons -->
                <div class="d-flex mt-4">
                    <form id="addToCartForm" action="{% url 'add_to_cart' %}" method="post">
                        {% csrf_token %}
                        <div class="mb-5">
                            <div class="input-group mb-3" style="max-width: 120px;">
                                <div class="input-group-prepend">
                                    <button class="btn btn-outline-primary js-btn-minus" type="button">&minus;</button>
                                </div>
                                <input name="quantity" type="text" class="form-control text-center" value="1" placeholder="" aria-label="Example text with button addon" aria-describedby="button-addon1">
                                <div class="input-group-append">
                                    <button class="btn btn-outline-primary js-btn-plus" type="button">&plus;</button>
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="buy-now btn btn-primary me-2" style="width: 150px;">Add To Cart</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Offers and Coupons Section -->
        <section id="offers-coupons" class="my-5">
            <div class="container">
                <h2 class="mb-4">Available Offers & Coupons</h2>
                <div class="offers-list">
                    <div class="offer mb-2 p-2 border rounded">
                        <h5 class="mb-1">Buy One Get One 50% Off</h5>
                        <p class="mb-1">Purchase one monitor and get a second monitor at 50% off. Limited time offer!</p>
                        <p class="text-muted mb-0">Expires: September 30, 2024</p>
                    </div>
                    <div class="offer mb-2 p-2 border rounded">
                        <h5 class="mb-1">Save $100 on Your Purchase</h5>
                        <p class="mb-1">Get an instant $100 discount on any monitor. Use code: MONITOR100 at checkout.</p>
                        <p class="text-muted mb-0">Expires: October 15, 2024</p>
                    </div>
                    <div class="coupon mb-2 p-2 border rounded">
                        <h5 class="mb-1">Additional 10% Off for Members</h5>
                        <p class="mb-1">Exclusive offer for members. Get an additional 10% off on your purchase.</p>
                        <p class="text-muted mb-0">Expires: October 31, 2024</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Customer Reviews Section -->
        <section id="customer-reviews" class="my-5">
            <div class="container">
                <h2 class="mb-4">Customer Reviews</h2>
                <div class="review mb-3 p-3 border rounded">
                    <h5 class="mb-2">John Doe</h5>
                    <p class="mb-1">"Great product! The quality is top-notch and the delivery was fast. Highly recommend."</p>
                    <p class="text-muted mb-0">Rating: ★★★★☆</p>
                </div>
                <div class="review mb-3 p-3 border rounded">
                    <h5 class="mb-2">Jane Smith</h5>
                    <p class="mb-1">"Good value for money. The monitor performs well, but the packaging could be improved."</p>
                    <p class="text-muted mb-0">Rating: ★★★☆☆</p>
                </div>
                <div class="review mb-3 p-3 border rounded">
                    <h5 class="mb-2">Alice Johnson</h5>
                    <p class="mb-1">"Excellent service and a fantastic product. I am very satisfied with my purchase."</p>
                    <p class="text-muted mb-0">Rating: ★★★★★</p>
                </div>
            </div>
        </section>
    </div>
</div>

<script>
    function updateMainImage(src) {
        const mainImage = document.getElementById('mainImage');
        mainImage.src = src;
    }

    function zoomImage(event) {
        const img = event.target;
        img.classList.add('zoomed');
    }

    function resetZoom() {
        const img = document.getElementById('mainImage');
        img.classList.remove('zoomed');
    }

    document.addEventListener('DOMContentLoaded', () => {
        const sizeOptions = document.getElementById('sizeOptions');
        const refreshRateOptions = document.getElementById('refreshRateOptions');
        const priceElement = document.getElementById('price');
        const sizeElement = document.getElementById('size');
        const refreshRateElement = document.getElementById('refreshRate');
        const stockElement = document.getElementById('stock');
        const addToCartBtn = document.querySelector('.btn-primary');
        const quantityInput = document.querySelector('input[name="quantity"]');
        const minusBtn = document.querySelector('.js-btn-minus');
        const plusBtn = document.querySelector('.js-btn-plus');
        const addToCartForm = document.getElementById('addToCartForm');
        const wishlistBtn = document.getElementById('wishlistBtn');
    
        let selectedSize = null;
        let selectedRefreshRate = null;
        let currentVariantId = null;
    
        function updateAddToCartButton(isEnabled) {
            addToCartBtn.textContent = isEnabled ? 'Add To Cart' : 'Out of Stock';
            addToCartBtn.disabled = !isEnabled; // Disable if not enabled
            addToCartBtn.classList.toggle('active', isEnabled);
        }
    
        function updateStockDisplay(stock) {
            if (stock <= 0) {
                stockElement.textContent = 'Out of Stock';
                stockElement.style.color = 'red';
                updateAddToCartButton(false);
            } else if (stock <= 5) {
                stockElement.textContent = `Only ${stock} Left`;
                stockElement.style.color = 'red';
                updateAddToCartButton(true);
            } else {
                stockElement.textContent = `Stock Left: ${stock}`;
                stockElement.style.color = 'black';
                updateAddToCartButton(true);
            }
        }
    
        function sendSelection() {
            const pId = "{{ product.id }}";
    
            fetch(`/product/${pId}/`, {
                method: 'POST',
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({ size: selectedSize, refreshRate: selectedRefreshRate })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                } else {
                    if (data.price) {
                        priceElement.textContent = `₹ ${data.price}`;
                        sizeElement.textContent = `Size: ${data.size} inch`;
                        refreshRateElement.textContent = `Refresh Rate: ${data.refreshRate} Hz`;
                        updateStockDisplay(data.stock);
                        currentVariantId = data.variantId;
                    }
    
                    // Ensure that sizes and refresh rates are only updated if available in the response
                    if (data.refreshRates && selectedSize) {
                        updateRefreshRateOptions(data.refreshRates);
                    }
    
                    if (data.sizes) {
                        updateSizeOptions(data.sizes);
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }
    
        function updateSizeOptions(sizes) {
            sizeOptions.innerHTML = '';
            sizes.forEach(size => {
                const input = document.createElement('input');
                input.type = 'radio';
                input.id = `size-${size.size_id}`;
                input.name = 'monitorSize';
                input.value = size.size_id;
                input.checked = size.size_id == selectedSize; // Retain the selected size
    
                const label = document.createElement('label');
                label.htmlFor = input.id;
                label.textContent = `${size.size__size} inches`;
    
                sizeOptions.appendChild(input);
                sizeOptions.appendChild(label);
            });
        }
    
        function updateRefreshRateOptions(refreshRates) {
            refreshRateOptions.innerHTML = '';
            refreshRates.forEach(rate => {
                const input = document.createElement('input');
                input.type = 'radio';
                input.id = `refresh-${rate.refreshRate_id}`;
                input.name = 'refreshRate';
                input.value = rate.refreshRate_id;
                input.checked = rate.refreshRate_id == selectedRefreshRate; // Retain the selected refresh rate
    
                const label = document.createElement('label');
                label.htmlFor = input.id;
                label.textContent = `${rate.refreshRate__refreshRate} Hz`;
    
                refreshRateOptions.appendChild(input);
                refreshRateOptions.appendChild(label);
            });
        }
    
        function handleSizeChange(e) {
            selectedSize = e.target.value;
            selectedRefreshRate = null;
            sendSelection();
        }
    
        function handleRefreshRateChange(e) {
            selectedRefreshRate = e.target.value;
            if (!selectedSize) {
                selectedSize = sizeOptions.querySelector('input:checked')?.value;
            }
            sendSelection();
        }
    
        function addToCart(event) {
            event.preventDefault();
            const quantity = parseInt(quantityInput.value);
            fetch('/add-to-cart/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    variant_id: currentVariantId,
                    quantity: quantity
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        title: 'Added to Cart!',
                        text: 'Product has been added to your cart.',
                        icon: 'success',
                        showCancelButton: true,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'View Cart',
                        cancelButtonText: 'Continue Shopping'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            window.location.href = '/cart/';
                        }
                    });
                    updateAddToCartButton(true);
                } else {
                    Swal.fire('Error', data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error adding to cart:', error);
                Swal.fire('Error', 'Select A Varient', 'error');
            });
        }

        function addToWishlist(event) {
            event.preventDefault();
            this.classList.toggle('active');
            fetch('{% url "addToWishlist" %}', {
                method: 'POST',
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}"
                }
            })
            .then(response => {
                if (response.ok) {
                    // Redirect to wishlist page after adding/removing
                    window.location.href = '{% url "wishlist" %}';
                } else {
                    console.error('Error in the response');
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }
    
        function updateQuantity(increment) {
            let quantity = parseInt(quantityInput.value);
            quantity += increment;
            if (quantity < 1) quantity = 1;
            quantityInput.value = quantity;
        }
    
        sizeOptions.addEventListener('change', handleSizeChange);
        refreshRateOptions.addEventListener('change', handleRefreshRateChange);
        addToCartForm.addEventListener('submit', addToCart);
        wishlistBtn.addEventListener('click',addToWishlist);
    
        // Set default variant
        const defaultVariantId = "{{ product.variants.first.id }}";
        currentVariantId = defaultVariantId;
        const defaultSize = sizeOptions.querySelector('input');
        if (!selectedSize && defaultSize) {
            defaultSize.checked = true;
            selectedSize = defaultSize.value;
            sendSelection(); // Trigger the default selection
        }
    });
</script>

{% endblock %}