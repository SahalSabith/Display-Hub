{% extends "base.html" %}
{% block baseContents %}
{% load static %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2ecc71;
            --background-color: #f8f9fa;
            --text-color: #333;
        }
        a{
            text-decoration: none;
        }
        .product-container {
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .main-image {
            position: relative;
            overflow: hidden;
            border-radius: 10px;
        }

        .zoomable {
            transition: transform 0.5s ease;
        }

        .thumbnails {
            display: flex;
            flex-direction: row;
            justify-content: center;
            margin-top: 1rem;
        }

        .thumbnail-img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 5px;
            margin: 0 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .thumbnail-img:hover {
            transform: scale(1.1);
        }

        .product-info-section {
            padding: 2rem;
        }

        .productName {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 1rem;
        }

        .price-container {
            display: flex;
            align-items: baseline;
            margin-bottom: 1rem;
        }

        .current-price {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .original-price {
            font-size: 1.5rem;
            text-decoration: line-through;
            color: #999;
            margin-left: 1rem;
        }

        .product-details {
            margin-bottom: 2rem;
        }

        .product-details h6 {
            margin-bottom: 0.5rem;
        }

        .filter-options {
            margin-bottom: 1.5rem;
        }

        .filter-options legend {
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .option-item {
            display: inline-block;
            margin-right: 1rem;
        }

        .option-item input[type="radio"] {
            display: none;
        }

        .option-item label {
            display: inline-block;
            padding: 0.5rem 1rem;
            background-color: #f0f0f0;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .option-item input[type="radio"]:checked + label {
            background-color: var(--primary-color);
            color: #fff;
        }

        .star-rating {
            font-size: 1.5rem;
            color: #ffc107;
            margin-bottom: 1rem;
        }

        .wishlist-btn {
            background-color: transparent;
            border: none;
            cursor: pointer;
            padding: 0;
            transition: all 0.3s ease;
            outline: none;
        }

        .heart-icon {
            fill: transparent;
            stroke: #ff4136;
            stroke-width: 2;
            transition: all 0.3s ease;
        }

        .wishlist-btn.active .heart-icon {
            fill: #ff4136;
        }

        .quantity-input {
            max-width: 120px;
        }

        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-primary:hover {
            background-color: #2980b9;
            border-color: #2980b9;
        }

        .offers-coupons {
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            margin-top: 3rem;
        }

        .offer, .coupon {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .offer:hover, .coupon:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .customer-reviews {
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            margin-top: 3rem;
        }

        .review {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .review:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        /* Optional: Add a color swatch feature */
        .color-swatch {
            display: inline-block;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin-right: 10px;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .color-swatch.active {
            border-color: var(--primary-color);
        }

        /* Optional: Add a product comparison feature */
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 2rem;
        }

        .comparison-table th, .comparison-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .comparison-table th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
    </style>
    <div class="site-section">
        <div class="container">
            <div class="product-container">
                <div class="row">
                    <!-- Thumbnails and Main Image -->
                    <div class="col-md-6">
                        <div class="main-image">
                            <img id="mainImage" src="" alt="Product Image" class="img-fluid zoomable" onmousemove="zoomImage(event)" onmouseleave="resetZoom(event)">
                        </div>
                        <div class="thumbnails">
                            <!-- Thumbnails will be populated by JavaScript -->
                        </div>
                    </div>

                    <!-- Product Information Section -->
                    <div class="col-md-6 product-info-section">
                        <h2 class="productName" id="product-name"></h2>
                        <div class="price-container">
                            <span class="current-price" id="price"></span>
                            <span class="original-price" id="orginalPrice"></span>
                        </div>
                        <div class="product-details">
                            <h6 id="size"></h6>
                            <h6>Resolution: <span id="resolution"></span></h6>
                            <h6 id="refreshRate"></h6>
                            <h6 id="stock"></h6>
                        </div>

                        <!-- Variant Selection -->
                        <div class="filter-options">
                            <legend>Monitor Size</legend>
                            <div id="sizeOptions" class="option-item">
                                <!-- Size options will be populated here by JavaScript -->
                            </div>
                        </div>

                        <div class="filter-options">
                            <legend>Refresh Rate</legend>
                            <div id="refreshRateOptions" class="option-item">
                                <!-- Refresh rate options will be populated here by JavaScript -->
                            </div>
                        </div>
                      
                        <!-- Customer Reviews -->
                        <div class="star-rating d-flex align-items-center">
                            <i class="bi bi-star-fill" data-value="1"></i>
                            <i class="bi bi-star-fill" data-value="2"></i>
                            <i class="bi bi-star-fill" data-value="3"></i>
                            <i class="bi bi-star-fill" data-value="4"></i>
                            <i class="bi bi-star" data-value="5"></i>
                            <span class="ms-2">(4.0 out of 5)</span>
                        </div>

                        <button class="wishlist-btn" id="wishlistBtn" aria-label="Add to Wishlist">
                            <svg class="heart-icon" viewBox="0 0 24 24" width="24" height="24">
                                <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                            </svg>
                            <span class="ms-2">Add to Wishlist</span>
                        </button>
                      
                        <!-- Buttons -->
                        <div class="d-flex mt-4">
                            <form id="addToCartForm" action="{% url 'add_to_cart' %}" method="post" class="d-flex align-items-center">
                                {% csrf_token %}
                                <div class="quantity-input me-3">
                                    <div class="input-group">
                                        <button class="btn btn-outline-secondary js-btn-minus" type="button">&minus;</button>
                                        <input name="quantity" type="text" class="form-control text-center" value="1" placeholder="" aria-label="Example text with button addon" aria-describedby="button-addon1">
                                        <button class="btn btn-outline-secondary js-btn-plus" type="button">&plus;</button>
                                    </div>
                                </div>
                                <button type="submit" class="buy-now btn btn-primary">Add To Cart</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Offers and Coupons Section -->
            <section id="offers-coupons" class="offers-coupons">
                <h2 class="mb-4">Available Offers & Coupons</h2>
                <div class="offers-list">
                    <div class="offer">
                        <h5 class="mb-1">Buy One Get One 50% Off</h5>
                        <p class="mb-1">Purchase one monitor and get a second monitor at 50% off. Limited time offer!</p>
                        <p class="text-muted mb-0">Expires: September 30, 2024</p>
                    </div>
                    <div class="offer">
                        <h5 class="mb-1">Save $100 on Your Purchase</h5>
                        <p class="mb-1">Get an instant $100 discount on any monitor. Use code: MONITOR100 at checkout.</p>
                        <p class="text-muted mb-0">Expires: October 15, 2024</p>
                    </div>
                    <div class="coupon">
                        <h5 class="mb-1">Additional 10% Off for Members</h5>
                        <p class="mb-1">Exclusive offer for members. Get an additional 10% off on your purchase.</p>
                        <p class="text-muted mb-0">Expires: October 31, 2024</p>
                    </div>
                </div>
            </section>

            <!-- Customer Reviews Section -->
            <section id="customer-reviews" class="customer-reviews">
                <h2 class="mb-4">Customer Reviews</h2>
                <div class="review">
                    <h5 class="mb-2">John Doe</h5>
                    <p class="mb-1">"Great product! The quality is top-notch and the delivery was fast. Highly recommend."</p>
                    <p class="text-muted mb-0">Rating: ★★★★☆</p>
                </div>
                <div class="review">
                    <h5 class="mb-2">Jane Smith</h5>
                    <p class="mb-1">"Good value for money. The monitor performs well, but the packaging could be improved."</p>
                    <p class="text-muted mb-0">Rating: ★★★☆☆</p>
                </div>
                <div class="review">
                    <h5 class="mb-2">Alice Johnson</h5>
                    <p class="mb-1">"Excellent service and a fantastic product. I am very satisfied with my purchase."</p>
                    <p class="text-muted mb-0">Rating: ★★★★★</p>
                </div>
            </section>

            <!-- Optional: Add a product comparison table -->
            <section id="product-comparison" class="customer-reviews">
                <h2 class="mb-4">Compare with Similar Products</h2>
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>Feature</th>
                            <th>This Product</th>
                            <th>Competitor A</th>
                            <th>Competitor B</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Screen Size</td>
                            <td>27"</td>
                            <td>24"</td>
                            <td>32"</td>
                        </tr>
                        <tr>
                            <td>Resolution</td>
                            <td>4K (3840 x 2160)</td>
                            <td>1080p (1920 x 1080)</td>
                            <td>1440p (2560 x 1440)</td>
                        </tr>
                        <tr>
                            <td>Refresh Rate</td>
                            <td>144Hz</td>
                            <td>60Hz</td>
                            <td>165Hz</td>
                        </tr>
                        <tr>
                            <td>Response Time</td>
                            <td>1ms</td>
                            <td>5ms</td>
                            <td>4ms</td>
                        </tr>
                        <tr>
                            <td>Price</td>
                            <td>$499</td>
                            <td>$299</td>
                            <td>$599</td>
                        </tr>
                    </tbody>
                </table>
            </section>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const pId = "{{ pId }}";
            const sizeOptions = document.getElementById('sizeOptions');
            const refreshRateOptions = document.getElementById('refreshRateOptions');
            const priceElement = document.getElementById('price');
            const sizeElement = document.getElementById('size');
            const refreshRateElement = document.getElementById('refreshRate');
            const stockElement = document.getElementById('stock');
            const addToCartBtn = document.querySelector('.btn-primary');
            const quantityInput = document.querySelector('input[name="quantity"]');
            const minusBtn = document.querySelector('.js-btn-minus');
            const plusBtn = document.querySelector('.js-btn-plus');
            const addToCartForm = document.getElementById('addToCartForm');
            const wishlistBtn = document.getElementById('wishlistBtn');
            const colorSwatches = document.querySelectorAll('.color-swatch');

            let selectedSize = null;
            let selectedRefreshRate = null;
            let currentVariantId = null;
            let currentStock = 0;

            function updateAddToCartButton(isEnabled) {
                addToCartBtn.textContent = isEnabled ? 'Add To Cart' : 'Out of Stock';
                addToCartBtn.disabled = !isEnabled;
                addToCartBtn.classList.toggle('active', isEnabled);
            }

            function updateStockDisplay(stock) {
                currentStock = stock;
                if (stock <= 0) {
                    stockElement.textContent = 'Out of Stock';
                    stockElement.style.color = 'red';
                    updateAddToCartButton(false);
                } else if (stock <= 5) {
                    stockElement.textContent = `Only ${stock} Left`;
                    stockElement.style.color = 'red';
                    updateAddToCartButton(true);
                } else {
                    stockElement.textContent = `Stock Left: ${stock}`;
                    stockElement.style.color = 'black';
                    updateAddToCartButton(true);
                }
            }

            function sendSelection() {
                fetch(`/product/${pId}/`, {
                    method: 'POST',
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify({ size: selectedSize, refreshRate: selectedRefreshRate })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        Swal.fire('Error', data.error, 'error');
                    } else {
                        if (data.price) {
                            priceElement.textContent = `₹ ${data.price}`;
                            document.getElementById('orginalPrice').innerText = `₹ ${data.orginalAmount}`;
                            sizeElement.textContent = `Size: ${data.size} inch`;
                            refreshRateElement.textContent = `Refresh Rate: ${data.refreshRate} Hz`;
                            updateStockDisplay(data.stock);
                            currentVariantId = data.variantId;
                        }

                        if (data.refreshRates && selectedSize) {
                            updateRefreshRateOptions(data.refreshRates);
                        }

                        if (data.sizes) {
                            updateSizeOptions(data.sizes);
                        }
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    Swal.fire('Error', 'An error occurred while fetching product data', 'error');
                });
            }

            function updateSizeOptions(sizes) {
                sizeOptions.innerHTML = '';
                sizes.forEach(size => {
                    const div = document.createElement('div');
                    div.className = 'option-item';
                    
                    const input = document.createElement('input');
                    input.type = 'radio';
                    input.id = `size-${size.size_id}`;
                    input.name = 'monitorSize';
                    input.value = size.size_id;
                    input.checked = size.size_id == selectedSize;

                    const label = document.createElement('label');
                    label.htmlFor = input.id;
                    label.textContent = `${size.size__size} inches`;

                    div.appendChild(input);
                    div.appendChild(label);
                    sizeOptions.appendChild(div);
                });
            }

            function updateRefreshRateOptions(refreshRates) {
                refreshRateOptions.innerHTML = '';
                refreshRates.forEach(rate => {
                    const div = document.createElement('div');
                    div.className = 'option-item';
                    
                    const input = document.createElement('input');
                    input.type = 'radio';
                    input.id = `refresh-${rate.refreshRate_id}`;
                    input.name = 'refreshRate';
                    input.value = rate.refreshRate_id;
                    input.checked = rate.refreshRate_id == selectedRefreshRate;

                    const label = document.createElement('label');
                    label.htmlFor = input.id;
                    label.textContent = `${rate.refreshRate__refreshRate} Hz`;

                    div.appendChild(input);
                    div.appendChild(label);
                    refreshRateOptions.appendChild(div);
                });
            }

            function handleSizeChange(e) {
                selectedSize = e.target.value;
                selectedRefreshRate = null;
                sendSelection();
            }

            function handleRefreshRateChange(e) {
                selectedRefreshRate = e.target.value;
                sendSelection();
            }

            function addToCart(event) {
                event.preventDefault();
                const quantity = parseInt(quantityInput.value);
                
                if (quantity > currentStock) {
                    Swal.fire('Error', 'Requested quantity exceeds available stock', 'error');
                    return;
                }
                
                if (!currentVariantId) {
                    Swal.fire('Error', 'Please select a variant', 'error');
                    return;
                }

                const priceContent = priceElement.textContent;
                const finalPrice = parseFloat(priceContent.replace('₹','').trim());

                fetch('/add-to-cart/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify({
                        variant_id: currentVariantId,
                        quantity: quantity,
                        price: finalPrice
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        Swal.fire({
                            title: 'Added to Cart!',
                            text: 'Product has been added to your cart.',
                            icon: 'success',
                            showCancelButton: true,
                            confirmButtonColor: '#3085d6',
                            cancelButtonColor: '#d33',
                            confirmButtonText: 'View Cart',
                            cancelButtonText: 'Continue Shopping'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                window.location.href = '/cart/';
                            }
                        });
                        updateAddToCartButton(true);
                    } else {
                        Swal.fire('Error', data.message, 'error');
                    }
                })
                .catch(error => {
                    console.error('Error adding to cart:', error);
                    Swal.fire('Error', 'An error occurred while adding to cart', 'error');
                });
            }

            function addToWishlist(event) {
                event.preventDefault();
                this.classList.toggle('active');
                fetch('{% url "addToWishlist" %}', {
                    method: 'POST',
                    headers: {
                        "X-CSRFToken": "{{ csrf_token }}"
                    },
                    body: JSON.stringify({
                        variant_id: currentVariantId,
                    })
                })
                .then(response => {
                    if (response.ok) {
                        window.location.href = '{% url "wishlist" %}';
                    } else {
                        console.error('Error in the response');
                        Swal.fire('Error', 'Select A Variant', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    Swal.fire('Error', 'An error occurred while adding to wishlist', 'error');
                });
            }

            function updateQuantity(increment) {
                let quantity = parseInt(quantityInput.value);
                if (quantity < 1) quantity = 1;
                if (quantity > currentStock) {
                    Swal.fire('Warning', 'Requested quantity exceeds available stock', 'warning');
                    quantity = currentStock;
                }
                quantityInput.value = quantity;
            }

            sizeOptions.addEventListener('change', handleSizeChange);
            refreshRateOptions.addEventListener('change', handleRefreshRateChange);
            addToCartForm.addEventListener('submit', addToCart);
            wishlistBtn.addEventListener('click', addToWishlist);
            minusBtn.addEventListener('click', () => updateQuantity(-1));
            plusBtn.addEventListener('click', () => updateQuantity(1));

            // Color swatch functionality
            colorSwatches.forEach(swatch => {
                swatch.addEventListener('click', function() {
                    colorSwatches.forEach(s => s.classList.remove('active'));
                    this.classList.add('active');
                    // You can add logic here to update the product image or other details based on the selected color
                });
            });

            // Set default variant
            const defaultSize = sizeOptions.querySelector('input');
            if (defaultSize) {
                defaultSize.checked = true;
                selectedSize = defaultSize.value;
                sendSelection();
            }

            // Initial product data fetch
            fetch(`/product/${pId}/`, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.product) {
                    const product = data.product;
                    const firstVariant = product.first_variant || {};
                    const orginalPrice = document.getElementById('orginalPrice');

                    if (product.offerStatus === true) {
                        orginalPrice.innerText = `₹ ${firstVariant.orginalAmount}`;
                    } else {
                        orginalPrice.style.display = 'none';
                    }

                    document.getElementById('product-name').innerText = product.name || 'N/A';
                    priceElement.innerText = firstVariant.price ? `₹ ${firstVariant.price}` : 'N/A';
                    sizeElement.innerText = firstVariant.size ? `Size: ${firstVariant.size} inch` : 'N/A';
                    refreshRateElement.innerText = firstVariant.refreshRate ? `Refresh Rate: ${firstVariant.refreshRate}Hz` : 'N/A';
                    updateStockDisplay(firstVariant.stock || 0);
                    document.getElementById('resolution').innerText = `${product.resolution}p` || 'N/A';

                    updateSizeOptions(data.varientSize);
                    updateRefreshRateOptions(data.varientRefreshRates);

                    const thumbnailContainer = document.querySelector('.thumbnails');
                    thumbnailContainer.innerHTML = '';
                    const mainImage = document.getElementById('mainImage');

                    product.images.forEach((imageUrl, index) => {
                        if (imageUrl) {
                            const thumbnail = document.createElement('img');
                            thumbnail.src = imageUrl;
                            thumbnail.className = 'thumbnail-img';
                            thumbnail.onclick = () => updateMainImage(imageUrl);
                            thumbnailContainer.appendChild(thumbnail);

                            if (index === 0) {
                                mainImage.src = imageUrl;
                            }
                        }
                    });
                } else {
                    console.error('No product data found.');
                    Swal.fire('Error', 'No product data found', 'error');
                }
            })
            .catch(error => {
                console.error('Error fetching product data:', error);
                Swal.fire('Error', 'An error occurred while fetching product data', 'error');
            });
        });

        function updateMainImage(imageUrl) {
            document.getElementById('mainImage').src = imageUrl;
        }

        function zoomImage(event) {
            const image = event.currentTarget;
            const zoomer = event.currentTarget.parentElement;
            const offsetX = event.offsetX;
            const offsetY = event.offsetY;
            const x = offsetX / zoomer.offsetWidth * 100;
            const y = offsetY / zoomer.offsetHeight * 100;
            image.style.transformOrigin = `${x}% ${y}%`;
            image.style.transform = "scale(2)";
        }

        function resetZoom(event) {
            const image = event.currentTarget;
            image.style.transformOrigin = "center center";
            image.style.transform = "scale(1)";
        }
    </script>
{% endblock %}